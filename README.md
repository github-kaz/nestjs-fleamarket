## 概要

本アプリケーションは、フリマサービスを想定したAPIサーバーです。
NestJSを用いたWebバックエンド設計の学習に加え、
実務を想定した「認証・認可」「トランザクション管理」
「並行処理への配慮」を意識して実装しています。

## 技術選定

- NestJS  
  Controller / Service / Module の責務が明確で、
  中〜大規模開発を想定した構成を取りやすいため採用。

- Prisma  
  型安全にDBアクセスが可能で、
  トランザクションやリレーション管理を明示的に扱えるため採用。

- RDB（PostgreSQL想定）  
  フリマサービスにおいては、
  データ整合性とトランザクション管理が重要なためRDBを採用。
  開発環境ではDocker上のPostgreSQLを使用しています。

## アーキテクチャ設計

- Controller  
  リクエストの受付、入力値検証、認証情報の取得のみを担当。
  業務ロジックは持たせない。

- Service  
  ユースケース単位の業務ロジックを担当。
  権限チェックや業務ルール判定はService層で行う。

- ORM（Prisma）  
  永続化処理に専念させ、
  業務判断はService層で行うよう責務を分離。

## 実務を想定して工夫した点

- トランザクション管理  
  商品の作成・更新・削除時にトランザクション処理を実装し、
  データ整合性と競合状態を防止しています。
  特に更新・削除時は、存在チェックと所有者チェックを
  トランザクション内で実行することで、同時リクエストによる
  競合を防いでいます。

- 認証・認可  
  JWT + Guard を用い、ログインユーザー前提のAPI設計とした。

- DTO + Validation  
  入力チェックはController層で行い、
  Service層に不正データを持ち込まない設計とした。

- 並行処理への配慮  
  トランザクション処理により、同時リクエストによる
  データ不整合を防止しています。
  将来的には楽観ロック（version/updatedAtチェック）の
  実装も可能な設計としています。

## 簡略化している点・今後の課題

- 決済処理は実装していません  
  本アプリでは決済連携は目的外とし、
  業務ロジック設計に注力しています。

- 権限ロールは最小限  
  管理者ロール等は拡張可能な設計としています。

- テストは一部のみ  
  全網羅ではなく、設計確認を目的とした最小限のテストとしています。

## セットアップ

### 必要な環境
- Node.js 18以上
- Docker Desktop（PostgreSQLはDocker上で動作させる想定）
- npm または yarn

### インストール

```bash
# 依存関係のインストール
npm install

# DockerでPostgreSQLを起動
docker compose up -d

# 環境変数の設定
cp .env.example .env
# .envファイルを編集してDATABASE_URLを設定
# 例: postgresql://nestjsuser:nestjspass@localhost:5432/fleamarket

# データベースマイグレーション
npx prisma migrate dev

# 開発サーバーの起動
npm run start:dev
```

### テスト実行

```bash
# ユニットテスト
npm test

# カバレッジ確認
npm run test:cov

```
